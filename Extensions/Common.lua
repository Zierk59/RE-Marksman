Common = {}

Common.HitChance = {
    Immposible = 0,
    Low = 1,
    Medium = 2,
    High = 3
}

Common.Items = {
    Unknown = 0,
    Boots_of_Speed = 1001,
    Faerie_Charm = 1004,
    Rejuvenation_Bead = 1006,
    Giants_Belt = 1011,
    Blasting_Wand = 1026,
    Sapphire_Crystal = 1027,
    Ruby_Crystal = 1028,
    Cloth_Armor = 1029,
    Chain_Vest = 1031,
    NullMagic_Mantle = 1033,
    Long_Sword = 1036,
    Pickaxe = 1037,
    BF_Sword = 1038,
    Hunters_Talisman = 1039,
    Hunters_Machete = 1041,
    Dagger = 1042,
    Recurve_Bow = 1043,
    Brawlers_Gloves = 1051,
    Amplifying_Tome = 1052,
    Vampiric_Scepter = 1053,
    Dorans_Shield = 1054,
    Dorans_Blade = 1055,
    Dorans_Ring = 1056,
    Negatron_Cloak = 1057,
    Needlessly_Large_Rod = 1058,
    Space_Vampiric_Scepter = 1059,
    The_Dark_Seal = 1082,
    Cull = 1083,
    Enchantment_Warrior = 1400,
    Enchantment_Cinderhulk = 1401,
    Enchantment_Runic_Echoes = 1402,
    Enchantment_Bloodrazor = 1416,
    Health_Potion = 2003,
    Mana_Potion = 2004,
    Total_Biscuit_of_Rejuvenation = 2009,
    Total_Biscuit_of_Everlasting_Will = 2010,
    Elixir_Of_Skill = 2011,
    Looted_Biscuit_of_Rejuvenation = 2012,
    Looted_Oracles_Extract = 2013,
    Kircheis_Shard = 2015,
    Refillable_Potion = 2031,
    Hunters_Potion = 2032,
    Corrupting_Potion = 2033,
    Explorers_Ward = 2050,
    Guardians_Horn = 2051,
    PoroSnax = 2052,
    Raptor_Cloak = 2053,
    Diet_PoroSnax = 2054,
    Control_Ward = 2055,
    Pilfered_Stealth_Ward = 2056,
    Peering_Farsight_Ward = 2057,
    Travel_Size_Elixir_of_Iron = 2058,
    Travel_Size_Elixir_of_Sorcery = 2059,
    Travel_Size_Elixir_of_Wrath = 2060,
    Pilfered_Health_Potion = 2061,
    Pilfered_Potion_of_Rouge = 2062,
    Shurelyas_Reverie = 2065,
    Sly_Sack_of_Gold = 2319,
    Minion_Dematerializer = 2403,
    Commencing_Stopwatch = 2419,
    Broken_Stopwatch = 2421,
    Slightly_Magical_Boots = 2422,
    Abyssal_Mask = 3001,
    Archangels_Staff = 3003,
    Manamune = 3004,
    Atmas_Reckoning = 3005,
    Berserkers_Greaves = 3006,
    Archangels_Staff_Quick_Charge = 3007,
    Manamune_Quick_Charge = 3008,
    Boots_of_Swiftness = 3009,
    Catalyst_of_Aeons = 3010,
    Sorcerers_Shoes = 3020,
    Frozen_Mallet = 3022,
    Glacial_Shroud = 3024,
    Iceborn_Gauntlet = 3025,
    Guardian_Angel = 3026,
    Rod_of_Ages = 3027,
    Chalice_of_Harmony = 3028,
    Rod_of_Ages_Quick_Charge = 3029,
    Hextech_GLP800 = 3030,
    Infinity_Edge = 3031,
    Mortal_Reminder = 3033,
    Last_Whisper = 3035,
    Lord_Dominiks_Regards = 3036,
    Seraphs_Embrace = 3040,
    Mejais_Soulstealer = 3041,
    Muramana = 3042,
    Phage = 3044,
    Phantom_Dancer = 3046,
    Ninja_Tabi = 3047,
    Zekes_Convergence = 3050,
    Jaurims_Fist = 3052,
    Steraks_Gage = 3053,
    Ohmwrecker = 3056,
    Sheen = 3057,
    Spirit_Visage = 3065,
    Kindlegem = 3067,
    Sunfire_Cape = 3068,
    Remnant_of_the_Ascended = 3069,
    Tear_of_the_Goddess = 3070,
    The_Black_Cleaver = 3071,
    The_Bloodthirster = 3072,
    Tear_of_the_Goddess_Quick_Charge = 3073,
    Ravenous_Hydra = 3074,
    Thornmail = 3075,
    Bramble_Vest = 3076,
    Tiamat = 3077,
    Trinity_Force = 3078,
    Space_Bloodthirster = 3080,
    Wardens_Mail = 3082,
    Warmogs_Armor = 3083,
    Overlords_Bloodmail = 3084,
    Runaans_Hurricane = 3085,
    Zeal = 3086,
    Statikk_Shiv = 3087,
    Rabadons_Deathcap = 3089,
    Wooglets_Witchcap = 3090,
    Wits_End = 3091,
    Remnant_of_the_Watchers = 3092,
    Rapid_Firecannon = 3094,
    Stormrazor = 3095,
    Nomads_Medallion = 3096,
    Targons_Brace = 3097,
    Frostfang = 3098,
    Lich_Bane = 3100,
    Stinger = 3101,
    Banshees_Veil = 3102,
    Lord_Van_Damms_Pillager = 3104,
    Aegis_of_the_Legion = 3105,
    Redemption = 3107,
    Fiendish_Codex = 3108,
    Knights_Vow = 3109,
    Frozen_Heart = 3110,
    Mercurys_Treads = 3111,
    Guardians_Orb = 3112,
    Aether_Wisp = 3113,
    Forbidden_Idol = 3114,
    Nashors_Tooth = 3115,
    Rylais_Crystal_Scepter = 3116,
    Boots_of_Mobility = 3117,
    Space_Knights_Vow = 3118,
    Wicked_Hatchet = 3122,
    Executioners_Calling = 3123,
    Guinsoos_Rageblade = 3124,
    Deathfire_Grasp = 3128,
    Sword_of_the_Divine = 3131,
    Caulfields_Warhammer = 3133,
    Serrated_Dirk = 3134,
    Void_Staff = 3135,
    Haunting_Guise = 3136,
    Dervish_Blade = 3137,
    Mercurial_Scimitar = 3139,
    Quicksilver_Sash = 3140,
    Youmuus_Ghostblade = 3142,
    Randuins_Omen = 3143,
    Bilgewater_Cutlass = 3144,
    Hextech_Revolver = 3145,
    Hextech_Gunblade = 3146,
    Duskblade_of_Draktharr = 3147,
    Space_Hextech_Gunblade = 3148,
    Space_Blade_of_the_Ruined_King = 3149,
    Liandrys_Torment = 3151,
    Hextech_Protobelt01 = 3152,
    Hexdrinker = 3155,
    Maw_of_Malmortius = 3156,
    Zhonyas_Hourglass = 3157,
    Ionian_Boots_of_Lucidity = 3158,
    Spear_of_Shojin = 3161,
    Space_Bilgewater_Cutlass = 3162,
    Space_Maw_of_Malmortius = 3163,
    Morellonomicon = 3165,
    Moonflair_Spellblade = 3170,
    Zephyr = 3172,
    Space_Boots_of_Lucidity = 3173,
    Athenes_Unholy_Grail = 3174,
    Head_of_KhaZix = 3175,
    Sanguine_Blade = 3181,
    Guardians_Hammer = 3184,
    Arcane_Sweeper = 3187,
    Locket_of_the_Iron_Solari = 3190,
    Seekers_Armguard = 3191,
    Gargoyle_Stoneplate = 3193,
    Adaptive_Helm = 3194,
    The_Hex_Core_mk1 = 3196,
    The_Hex_Core_mk2 = 3197,
    Perfect_Hex_Core = 3198,
    Prototype_Hex_Core = 3200,
    Spectres_Cowl = 3211,
    Mikaels_Crucible = 3222,
    Space_Ravenous_Hydra = 3230,
    Space_Mercurial_Scimitar = 3231,
    Ludens_Echo = 3285,
    Ancient_Coin = 3301,
    Relic_Shield = 3302,
    Spellthiefs_Edge = 3303,
    Timeworn_Ancient_Coin = 3304,
    Timeworn_Nomads_Medallion = 3305,
    Timeworn_Talisman_of_Ascension = 3306,
    Timeworn_Relic_Shield = 3307,
    Timeworn_Targons_Brace = 3308,
    Timeworn_Face_of_the_Mountain = 3309,
    Timeworn_Spellthiefs_Edge = 3310,
    Timeworn_Frostfang = 3311,
    Timeworn_Frost_Queens_Claim = 3312,
    Warding_Totem_Trinket = 3340,
    Soul_Anchor_Trinket = 3345,
    Greater_Stealth_Totem_Trinket = 3361,
    Greater_Vision_Totem_Trinket = 3362,
    Farsight_Alteration = 3363,
    Oracle_Lens = 3364,
    Molten_Edge = 3371,
    Forgefire_Cape = 3373,
    Rabadons_Deathcrown = 3374,
    Infernal_Mask = 3379,
    The_Obsidian_Cleaver = 3380,
    Salvation = 3382,
    Circlet_of_the_Iron_Solari = 3383,
    Trinity_Fusion = 3384,
    Wooglets_Witchcrown = 3385,
    Zhonyas_Paradox = 3386,
    Frozen_Fist = 3387,
    Youmuus_Wraithblade = 3388,
    Might_of_the_Ruined_King = 3389,
    Ludens_Pulse = 3390,
    Your_Cut = 3400,
    Remnant_of_the_Aspect = 3401,
    Golden_Transcendence = 3460,
    Golden_Transcendence_Disabled = 3461,
    Seer_Stone_Trinket = 3462,
    Ardent_Censer = 3504,
    Essence_Reaver = 3508,
    ZzRot_Portal = 3512,
    Eye_of_the_Herald = 3513,
    Ghost_Poro = 3520,
    The_Black_Spear = 3599,
    Siege_Teleport = 3630,
    Siege_Ballista = 3631,
    Tower_Beam_of_Ruination = 3634,
    Port_Pad = 3635,
    Tower_Storm_Bulwark = 3636,
    Nexus_Siege_Siege_Weapon_Slot = 3637,
    Flash_Zone = 3640,
    Vanguard_Banner = 3641,
    Siege_Refund = 3642,
    Entropy_Field = 3643,
    Shield_Totem = 3647,
    Siege_Teleport_Inactive = 3648,
    Siege_Sight_Warder = 3649,
    Frosted_Snax = 3680,
    Super_Spicy_Snax = 3681,
    Espresso_Snax = 3682,
    Rainbow_Snax_Party_Pack = 3683,
    Cosmic_Shackle = 3690,
    Singularity_Lantern = 3691,
    Dark_Matter_Scythe = 3692,
    Gravity_Boots = 3693,
    Cloak_of_Stars = 3694,
    Dark_Star_Sigil = 3695,
    Stalkers_Blade = 3706,
    Skirmishers_Sabre = 3715,
    Dead_Mans_Plate = 3742,
    Titanic_Hydra = 3748,
    Bamis_Cinder = 3751,
    Righteous_Glory = 3800,
    Crystalline_Bracer = 3801,
    Lost_Chapter = 3802,
    Deaths_Dance = 3812,
    Space_Deaths_Dance = 3813,
    Edge_of_Night = 3814,
    Fire_at_Will = 3901,
    Deaths_Daughter = 3902,
    Raise_Morale = 3903,
    Twin_Shadows = 3905,
    Spellbinder = 3907,
    Oblivion_Orb = 3916,
    Ghostwalkers_Melee_Only = 4001,
    Lifeline = 4003,
    Spectral_Cutlass = 4004,
    Pridestalkers_Blade = 4101,
    Dorans_Lost_Shield = 4201,
    Dorans_Lost_Blade = 4202,
    Dorans_Lost_Ring = 4203,
    Dorans_Lost_Idol = 4204,
    Philosophers_Medallion = 4301,
    Heart_of_Targon = 4302,
    Force_of_Nature = 4401,
    Innervating_Locket = 4402,
    StatStick_of_Stoicism = 4403
}

function Common:IsPosInUnitAARange(unit, pos)
    return (unit.pos:dist(pos) < unit.attackRange)
end

function Common:IsInRange(unit1, unit2, range)
    return (unit1.pos:dist(unit2.pos) < range)
end

function Common:IsMinionValid(unit, team)
    return (unit and unit.ptr ~= 0 and unit.team == team and (unit.type == TYPE_MINION) and (not unit.isDead) and unit.isTargetable and unit.isVisible and unit.health > 0)
end

function Common:GetMinions(pos, range, team)
    local result = {}

    for i = 0, objManager.minions.size[team] - 1 do
        local minion = objManager.minions[team][i]

        if self:IsMinionValid(minion, team) and minion.pos:dist(pos) < range then
            result[#result + 1] = minion
        end
    end

    return result
end

function Common:CountMinionsInRange(pos, range, team)
    local result = 0

    for i = 0, objManager.minions.size[team] - 1 do
        local minion = objManager.minions[team][i]

        if self:IsMinionValid(minion, team) and minion.pos:dist(pos) < range then
            result = result + 1
        end
    end

    return result
end

function Common:IsValidTarget(unit, range)
    return unit and unit.ptr ~= 0 and (unit.team == TEAM_ENEMY) and (unit.type == TYPE_HERO) and unit.isVisible and unit.isTargetable and (not unit.isDead) and (not self:IsImmortal(unit)) and (not range or player.pos:dist(unit.pos) <= range)
end

function Common:HasBuff(unit, buffName)
    for i = 0, unit.buffManager.count - 1 do
        local buff = unit.buffManager:get(i)

        if buff and buff.valid and buff.name == buffName then
            return true            
        end        
    end

    return false     
end

function Common:HasBuffOfType(unit, type)
    for i = 0, unit.buffManager.count - 1 do
        local buff = unit.buffManager:get(i)

        if buff and buff.valid and buff.type == type then
            return true            
        end        
    end

    return false     
end

function Common:HasItem(unit, itemId)
    for i = 0, 6 do
        if unit:itemID(i) == itemId then
            return true
        end
    end

    return false
end

function Common:IsImmortal(unit)
    for i = 0, unit.buffManager.count - 1 do
        local buff = unit.buffManager:get(i)

        if buff and buff.valid and buff.type == 17 then
            return true
        end
    end

    return false
end

function Common:GetEnemyHeroes(range) 
    local result = {}
    for i = 0, objManager.enemies_n - 1 do
        local unit = objManager.enemies[i]

        if self:IsValidTarget(unit) and player.pos:dist(unit.pos) < range then
            result[#result + 1] = unit
        end
    end

    return result
end

function Common:CountEnemiesInRange(range)
    return #self:GetEnemyHeroes(range)
end

function Common:GetAllyHeroes(range) 
    local result = {}
    for i = 0, objManager.allies_n - 1 do
        local unit = objManager.allies[i]

        if unit and (not unit.isDead) and player.pos:dist(unit.pos) < range then
            result[#result + 1] = unit
        end
    end

    return result
end

function Common:CountAlliesInRange(range)
    return #self:GetAllyHeroes(range)
end

local range_check = 0
local function select_target(res, obj, dist)
    if dist > range_check then 
        return 
    end

    if Common:IsImmortal(obj) then
        return
    end

    res.obj = obj
    return true
end

function Common:GetTarget(range)
    range_check = range
    return Controller.TargetSelector.get_result(select_target).obj    
end

function Common:HasSpellShield(unit)
    for i = 0, unit.buffManager.count - 1 do
        local buff = unit.buffManager:get(i)

        if buff and buff.valid and (buff.type == 4 or buff.type == 15) then
            return true
        end
    end

    return false
end

function Common:GetTotalHealthWithShields(unit)
    return ((unit.health or 0) + (unit.allShield or 0) + (unit.physicalShield or 0))
end

function Common:IsValidTurret(unit)
    return (unit and unit.ptr ~= 0 and (not unit.isDead) and unit.isVisible)
end

function Common:GetTurrets(team)
    local result = {}
    for i = 0, objManager.turrets.size[team] - 1 do
        local unit = objManager.turrets[team][i]

        if self:IsValidTarget(unit) then
            result[#result + 1] = unit
        end
    end

    return result
end

function Common:IsPosUnderEnemyTurret(pos)
    local turrets = self:GetTurrets(TEAM_ENEMY)

    for i = 1, #turrets do
        if self:IsPosInUnitAARange(turrets[i], pos) then
            return true
        end
    end

    return false
end

function Common:GetTotalAttackDamage(unit)
    return (unit.baseAttackDamage + unit.flatPhysicalDamageMod) * unit.percentPhysicalDamageMod
end
  
function Common:GetBonusAttackDamage(unit)
    return ((unit.baseAttackDamage + unit.flatPhysicalDamageMod) * unit.percentPhysicalDamageMod) - unit.baseAttackDamage
end

function Common:GetAutoAttackDamage(target)
    local source = player

    if target then
        return self:GetTotalAttackDamage(source) * self:GetPhysicalReduction(target, source)
    end

    return 0
end

function Common:GetPhysicalReduction(target, source)
    local armor = ((target.bonusArmor * source.percentBonusArmorPenetration) + (target.armor - target.bonusArmor)) * source.percentArmorPenetration
    local lethality = (source.physicalLethality * .4) + ((source.physicalLethality * .6) * (source.levelRef / 18))

    return armor >= 0 and (100 / (100 + (armor - lethality))) or (2 - (100 / (100 - (armor - lethality))))
end

function Common:GetLastPath(unit)
    return unit.path
end

function Common:IsFacing(unit, pos)
    local facingPos = pos.type == vec3.type and pos or pos.pos
    local angle = mathf.angle_between(unit.pos, facingPos, unit.pos + unit.direction * 100) * 180 / math.pi

    if math.abs(angle) < 40 then
        return true
    end
end

function Common:IsMovingTowards(unit, minDistance)
    if minDistance == nil then
        minDistance = 0
    end

    local safetyDistance = (minDistance == 0) and unit.attackRange or minDistance

    if player.pos:dist(unit.pos) < safetyDistance then
        return true
    end

    if player.pos:dist(self:GetLastPath(player).serverPos) < 10 then
        return false
    end

    return (self:IsFacing(unit.pos) and self:GetLastPath(player).serverPos:dist(unit.pos) < (safetyDistance * safetyDistance))
end

return Common